<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Notices | BDS Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#001532;
  color:#fff;
}
header{
  background:#000000dd;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a, header button{
  background:#ffbf00;
  color:#000;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  font-size:13px;
  cursor:pointer;
  text-decoration:none;
  font-weight:bold;
}
.container{
  max-width:900px;
  margin:14px auto;
  padding:10px;
}
h1{margin:0 0 10px;font-size:22px;}
label{font-size:13px;display:block;margin-top:8px;}
input[type="text"], textarea{
  width:100%;
  padding:6px;
  border-radius:6px;
  border:none;
  margin-top:3px;
  font-size:13px;
  box-sizing:border-box;
}
textarea{min-height:70px;}
button.primary{
  margin-top:10px;
  background:#ffbf00;
  color:#000;
  border:none;
  padding:7px 14px;
  border-radius:999px;
  font-weight:bold;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  font-size:13px;
}
th,td{
  border:1px solid #ffffff55;
  padding:6px;
}
th{
  background:#ffbf00;
  color:#000;
}
.badge{
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
}
.badge-on{background:lightgreen;color:#000;}
.badge-off{background:#ff5252;color:#fff;}
.small-btn{
  padding:3px 7px;
  border-radius:999px;
  border:none;
  font-size:11px;
  cursor:pointer;
}
.file-name { font-size:12px; color:#fff; opacity:0.9; }
.meta { font-size:11px; opacity:0.8; color:#ddd; }
.status { margin-left:8px; font-size:13px; vertical-align:middle; }
</style>

<!-- Supabase JS v2 (browser UMD) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <a href="dashboard.html">⬅ Dashboard</a>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">
  <h1>Manage Notices (Text + File upload)</h1>

  <form id="noticeForm">
    <label>Notice Title
      <input type="text" id="nTitle" required placeholder="e.g. Syllabus Feb 2026">
    </label>
    <label>Notice Text (short)
      <textarea id="nBody" required placeholder="Brief description or instructions..."></textarea>
    </label>

    <label>Attach File (optional) — PDF / DOC / DOCX
      <input type="file" id="nFile" accept=".pdf,.doc,.docx" />
    </label>

    <div style="margin-top:8px;">
      <button class="primary" type="submit" id="uploadBtn">Add Notice</button>
      <span id="noticeStatus" class="status meta"></span>
    </div>
  </form>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Title</th>
        <th>Text</th>
        <th>File</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="noticesBody"></tbody>
  </table>
</div>

<script>
  // Admin guard
  if (localStorage.getItem("bdsAdminLoggedIn") !== "yes") {
    window.location.href = "login.html";
  }
  function logout(){
    localStorage.removeItem("bdsAdminLoggedIn");
    window.location.href="login.html";
  }
  window.logout = logout;

  // Supabase config (same as other admin pages)
  const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eW1qaHV3anZ5eWt1a2Z6cW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMzMjIsImV4cCI6MjA4MDI0OTMyMn0.Ja9Do4cwumTnXx2NGIRW8Ti3rKm4MBiLClQz0xjOtrQ";

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // constants
  const NOTICE_BUCKET = 'notices'; // storage bucket name (create this and set public)
  const NOTICE_TABLE  = 'notices'; // table (id, title, body, file_path, active, created_at)

  const form  = document.getElementById("noticeForm");
  const tbody = document.getElementById("noticesBody");
  const statusSpan = document.getElementById("noticeStatus");
  const uploadBtn = document.getElementById("uploadBtn");

  // escape helper to avoid inserting raw HTML
  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
    });
  }

  // upload handler (text + optional file)
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const title = document.getElementById("nTitle").value.trim();
    const body  = document.getElementById("nBody").value.trim();
    const fileInput = document.getElementById("nFile");
    const file = fileInput.files[0];

    if(!title || !body){
      alert("Title aur notice text dono zaroori hain.");
      return;
    }

    statusSpan.style.color = '#fff';
    statusSpan.textContent = 'Processing...';
    uploadBtn.disabled = true;

    try{
      let uploadedPath = null;
      if(file){
        // create safe path
        const ts = Date.now();
        const safeName = file.name.replace(/\s+/g,'_').replace(/[^\w\-.]/g,'');
        uploadedPath = `${ts}_${safeName}`;

        const { error: uploadErr } = await sb.storage.from(NOTICE_BUCKET).upload(uploadedPath, file, { upsert: true });
        if(uploadErr){
          throw uploadErr;
        }
      }

      // insert into notices table with optional file_path
      const insertObj = {
        title: title,
        body: body,
        active: true,
        file_path: uploadedPath // may be null
      };

      const { data: insData, error: insErr } = await sb.from(NOTICE_TABLE).insert([insertObj]).select().single();
      if(insErr){
        // rollback uploaded file if present
        if(uploadedPath){
          await sb.storage.from(NOTICE_BUCKET).remove([uploadedPath]).catch(()=>{});
        }
        throw insErr;
      }

      statusSpan.style.color = 'lightgreen';
      statusSpan.textContent = 'Notice added.';
      form.reset();
      loadNotices();

    }catch(err){
      console.error(err);
      statusSpan.style.color = 'salmon';
      statusSpan.textContent = 'Error: ' + (err.message || err);
    }finally{
      uploadBtn.disabled = false;
      setTimeout(()=> statusSpan.textContent = '', 3500);
    }
  });


  // load notices list
  async function loadNotices(){
    tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
    try{
      const { data, error } = await sb
        .from(NOTICE_TABLE)
        .select('*')
        .order('created_at', { ascending: false });

      if(error){
        tbody.innerHTML = `<tr><td colspan='6'>Error loading notices: ${escapeHtml(error.message)}</td></tr>`;
        return;
      }

      if(!data || data.length === 0){
        tbody.innerHTML = "<tr><td colspan='6'>No notices found.</td></tr>";
        return;
      }

      let i = 1;
      let html = '';
      data.forEach(row => {
        const active = row.active !== false;
        const createdText = row.created_at ? new Date(row.created_at).toLocaleString() : '';
        // file public url (if exists)
        let fileHtml = '<span style="color:#999">—</span>';
        if(row.file_path){
          try{
            const { data: urlData } = sb.storage.from(NOTICE_BUCKET).getPublicUrl(row.file_path);
            const url = urlData && urlData.publicUrl ? urlData.publicUrl : '';
            if(url){
              fileHtml = `<a class="file-name" href="${escapeHtml(url)}" target="_blank" rel="noopener">Download</a>`;
            } else {
              // show filename text if public url not available
              fileHtml = `<span class="file-name">${escapeHtml(row.file_path)}</span>`;
            }
          }catch(e){
            fileHtml = `<span class="file-name">${escapeHtml(row.file_path)}</span>`;
          }
        }

        html += `<tr>
          <td>${i++}</td>
          <td>${escapeHtml(row.title || '')}</td>
          <td>${escapeHtml(row.body || '')}</td>
          <td style="white-space:nowrap;">${fileHtml}</td>
          <td>
            <span class="badge ${active ? 'badge-on' : 'badge-off'}">${active ? 'Visible' : 'Hidden'}</span>
            <div class="meta">${escapeHtml(createdText)}</div>
          </td>
          <td style="white-space:nowrap;">
            <button class="small-btn" onclick="toggleNotice(${row.id}, ${active})">${active ? 'Hide' : 'Show'}</button>
            <button class="small-btn" style="background:#ff5252;color:#fff;" onclick="deleteNotice(${row.id}, ${row.file_path ? `'${escapeJsString(row.file_path)}'` : 'null'})">Delete</button>
          </td>
        </tr>`;
      });

      tbody.innerHTML = html;

    }catch(err){
      console.error(err);
      tbody.innerHTML = `<tr><td colspan='6'>Unexpected error.</td></tr>`;
    }
  }

  // helper to escape single quotes/newlines for inline js when injecting path
  function escapeJsString(s){
    if(!s) return '';
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n');
  }
  window.escapeJsString = escapeJsString;

  // toggle visibility
  async function toggleNotice(id,current){
    try{
      const { error } = await sb.from(NOTICE_TABLE).update({ active: !current }).eq('id', id);
      if(error) throw error;
      loadNotices();
    }catch(err){
      console.error(err);
      alert('Error toggling notice: ' + (err.message || err));
    }
  }
  window.toggleNotice = toggleNotice;

  // delete notice: first fetch file_path (if not provided), remove storage file, then delete row
  async function deleteNotice(id, filePathArg){
    if(!confirm('Are you sure you want to delete this notice?')) return;

    const noticeStatus = document.getElementById("noticeStatus");
    noticeStatus.style.color = '#fff';
    noticeStatus.textContent = 'Deleting...';

    try{
      let filePath = filePathArg && filePathArg !== 'null' ? filePathArg : null;

      // If filePath not passed, fetch it
      if(!filePath){
        const { data, error } = await sb.from(NOTICE_TABLE).select('file_path').eq('id', id).single();
        if(error) throw error;
        filePath = data ? data.file_path : null;
      }

      // delete row from table
      const { error: delRowErr } = await sb.from(NOTICE_TABLE).delete().eq('id', id);
      if(delRowErr) throw delRowErr;

      // delete file from storage if exists (ignore error)
      if(filePath){
        await sb.storage.from(NOTICE_BUCKET).remove([filePath]).catch((e)=>console.warn('storage remove err', e));
      }

      noticeStatus.style.color = 'lightgreen';
      noticeStatus.textContent = 'Deleted.';
      loadNotices();

    }catch(err){
      console.error(err);
      noticeStatus.style.color = 'salmon';
      noticeStatus.textContent = 'Delete failed: ' + (err.message || err);
    }finally{
      setTimeout(()=> noticeStatus.textContent = '', 2500);
    }
  }
  window.deleteNotice = deleteNotice;

  // initial load
  loadNotices();

</script>

</body>
</html>
