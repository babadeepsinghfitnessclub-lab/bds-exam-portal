<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; }
  .container {
    max-width: 1000px;
    margin: 15px auto;
    background:#fff;
    padding: 12px 15px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  h1 { margin-top:0; color:#b20c0c; }
  table {
    width:100%; border-collapse: collapse; margin-top:10px; font-size:13px;
  }
  th, td {
    border:1px solid #ddd; padding:6px; text-align:left;
  }
  th { background:#eee; }
  tr:nth-child(even){ background:#fafafa; }
  button {
    padding:5px 8px; border:none; border-radius:4px;
    cursor:pointer; font-size:12px; margin:2px;
  }
  .btn-view { background:#1976d2; color:#fff; }
  .btn-approve { background:#2e7d32; color:#fff; }
  .btn-pending { background:#ffa000; color:#000; }
  .btn-reject { background:#c62828; color:#fff; }
  .msg { margin-top:6px; font-size:13px; }
  .detail-card {
    margin-top:12px;
    padding:10px;
    border-radius:6px;
    background:#fafafa;
    border:1px solid #ddd;
    font-size:14px;
  }
  .field-label { font-weight:bold; }
  a { color:#1976d2; }
  .topbar-links a { margin-right:8px; font-size:13px; }

  .section-title{
    margin-top:10px;
    font-weight:bold;
    border-bottom:1px solid #ccc;
    padding-bottom:3px;
    margin-bottom:4px;
  }
  .row-2col{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .row-2col > div{
    flex:1 1 160px;
  }
  input[type="text"], input[type="number"]{
    width:100%;
    padding:4px 6px;
    margin-top:2px;
    box-sizing:border-box;
    border-radius:4px;
    border:1px solid #ccc;
    font-size:13px;
  }
  label{font-size:13px;}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <div class="topbar-links">
    <a href="dashboard.html">← Admin Home</a> |
    <a href="../index.html" target="_blank">Open Website</a>
  </div>

  <h1>Student Applications</h1>

  <p class="msg" id="listMsg">Loading...</p>

  <table id="appsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Mobile</th>
        <th>Centre</th>
        <th>Form Status</th>
        <th>Payment</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="appsBody"></tbody>
  </table>

  <div id="detailBox" class="detail-card" style="display:none;">
    <div class="section-title">Student Details</div>
    <p><span class="field-label">Name:</span> <span id="dName"></span></p>
    <p><span class="field-label">Father:</span> <span id="dFather"></span></p>
    <p><span class="field-label">Mobile:</span> <span id="dMobile"></span></p>
    <p><span class="field-label">Roll No:</span> <span id="dRoll"></span></p>
    <p><span class="field-label">Form Status:</span> <span id="dStatus"></span></p>
    <p><span class="field-label">Payment Status:</span> <span id="dPayment"></span></p>
    <p><span class="field-label">UPI Txn ID:</span> <span id="dTxn"></span></p>
    <p><span class="field-label">Address:</span> <span id="dAddress"></span></p>
    <p><span class="field-label">Qualification:</span> <span id="dQual"></span></p>

    <div class="section-title">Documents</div>
    <p><span class="field-label">Photo:</span> <a id="dPhoto" target="_blank">Open</a></p>
    <p><span class="field-label">Aadhaar Front:</span> <a id="dAadharF" target="_blank">Open</a></p>
    <p><span class="field-label">Aadhaar Back:</span> <a id="dAadharB" target="_blank">Open</a></p>
    <p><span class="field-label">Marksheet:</span> <a id="dMarksheet" target="_blank">Open</a></p>
    <p><span class="field-label">Payment Screenshot:</span> <a id="dPaymentSS" target="_blank">Open</a></p>

    <div class="section-title">Payment / Form Status</div>
    <div>
      <button class="btn-approve" onclick="updateStatus('approved', true)">Approve</button>
      <button class="btn-pending" onclick="updateStatus('pending', false)">Pending</button>
      <button class="btn-reject" onclick="updateStatus('rejected', false)">Reject</button>
    </div>

    <div class="section-title">Exam Centre & Admit Card</div>

    <label>Exam Centre (school / city etc.)</label>
    <input type="text" id="centerInput" placeholder="e.g. Govt Sr Sec School, Sangariya">

    <div class="row-2col" style="margin-top:6px;">
      <div>
        <label>Exam Date</label>
        <input type="text" id="examDateInput" placeholder="e.g. 08-02-2026">
      </div>
      <div>
        <label>Exam Shift</label>
        <input type="text" id="examShiftInput" placeholder="Morning / Evening">
      </div>
    </div>

    <div class="row-2col" style="margin-top:6px;">
      <div>
        <label>Start Time</label>
        <input type="text" id="examStartInput" placeholder="e.g. 10:00 AM">
      </div>
      <div>
        <label>End Time</label>
        <input type="text" id="examEndInput" placeholder="e.g. 01:00 PM">
      </div>
    </div>

    <label style="margin-top:6px;display:inline-flex;align-items:center;gap:4px;">
      <input type="checkbox" id="admitAllow">
      Admit card active kare? (payment approved + ye tick ⇒ student admit card download kar sakta hai)
    </label>

    <div style="margin-top:8px;">
      <button class="btn-approve" onclick="saveCentreAdmit()">Save Centre / Admit</button>
    </div>

    <div class="section-title">Result Update</div>
    <div class="row-2col">
      <div>
        <label>Marks</label>
        <input type="number" id="rMarks" placeholder="e.g. 87">
      </div>
      <div>
        <label>Rank</label>
        <input type="number" id="rRank" placeholder="e.g. 12">
      </div>
    </div>
    <label style="display:block;margin-top:6px;">Result Status</label>
    <input type="text" id="rStatus" placeholder="Pass / Fail / Scholarship etc.">

    <label style="margin-top:6px;display:inline-flex;align-items:center;gap:4px;">
      <input type="checkbox" id="rPublish">
      Result publish kare? (website par show hoga)
    </label>

    <div style="margin-top:8px;">
      <button class="btn-approve" onclick="saveResult()">Save Result</button>
    </div>

    <p class="msg" id="detailMsg"></p>
  </div>

</div>

<script>
// Admin login check
if(localStorage.getItem("bdsAdminLoggedIn")!=="yes"){
  window.location.href="login.html";
}

const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eW1qaHV3anZ5eWt1a2Z6cW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMzMjIsImV4cCI6MjA4MDI0OTMyMn0.Ja9Do4cwumTnXx2NGIRW8Ti3rKm4MBiLClQz0xjOtrQ";

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentId = null;

function fileUrl(path){
  if(!path) return "";
  const { data } = sb.storage.from("student_docs").getPublicUrl(path);
  return data && data.publicUrl ? data.publicUrl : "";
}

function setDocLink(anchorId, path){
  const a = document.getElementById(anchorId);
  if(!path){
    a.textContent = "Not uploaded";
    a.removeAttribute("href");
    a.style.pointerEvents = "none";
    a.style.opacity = "0.6";
    return;
  }
  const url = fileUrl(path);
  if(url){
    a.href = url;
    a.target = "_blank";
    a.textContent = "Open";
    a.style.pointerEvents = "auto";
    a.style.opacity = "1";
  }else{
    a.textContent = "Error";
    a.removeAttribute("href");
    a.style.pointerEvents = "none";
    a.style.opacity = "0.6";
  }
}

async function loadStudents(){
  const listMsg = document.getElementById("listMsg");
  listMsg.textContent = "Loading...";

  const { data, error } = await sb
    .from("students")
    .select("*")
    .order("created_at",{ ascending: false });

  if(error){
    listMsg.textContent = "Error: "+error.message;
    return;
  }

  const body = document.getElementById("appsBody");
  body.innerHTML = "";
  let i=1;

  data.forEach(st=>{
    if(!st.roll_number) return;
    const tr = document.createElement("tr");

    const formStatus = st.form_status || st.status || "pending";
    const paymentStatus = st.payment_status
      || (st.payment_verified ? "approved" : "pending");

    tr.innerHTML =
      `<td>${i++}</td>
       <td>${st.roll_number}</td>
       <td>${st.full_name || st.name || ""}</td>
       <td>${st.mobile || ""}</td>
       <td>${st.exam_center || "-"}</td>
       <td>${formStatus}</td>
       <td>${paymentStatus}</td>
       <td>
         <button class="btn-view">View</button>
         <button class="btn-reject btn-del">Delete</button>
       </td>`;

    const viewBtn = tr.querySelector(".btn-view");
    const delBtn  = tr.querySelector(".btn-del");

    viewBtn.onclick = ()=>openDetails(st);
    delBtn.onclick  = ()=>deleteStudent(st);

    body.appendChild(tr);
  });

  listMsg.textContent = "Loaded successfully.";
}
loadStudents();

function openDetails(st){
  currentId = st.id;

  document.getElementById("detailBox").style.display="block";
  document.getElementById("detailMsg").textContent = "";

  document.getElementById("dName").textContent   = st.full_name || st.name || "";
  document.getElementById("dFather").textContent = st.father_name || "";
  document.getElementById("dMobile").textContent = st.mobile || "";
  document.getElementById("dRoll").textContent   = st.roll_number || "";

  const formStatus = st.form_status || st.status || "pending";
  const payApproved =
    (st.payment_status && st.payment_status.toLowerCase()==="approved") ||
    st.payment_verified === true;

  document.getElementById("dStatus").textContent   = formStatus;
  document.getElementById("dPayment").textContent  = payApproved ? "approved" : "pending";
  document.getElementById("dTxn").textContent      = st.upi_txn || st.txn_id || "";
  document.getElementById("dAddress").textContent  = st.address || "";
  document.getElementById("dQual").textContent     = st.qualification || "";

  setDocLink("dPhoto",     st.photo_path);
  setDocLink("dAadharF",   st.aadhar_front_path);
  setDocLink("dAadharB",   st.aadhar_back_path);
  setDocLink("dMarksheet", st.marksheet_path);
  setDocLink("dPaymentSS", st.payment_screenshot_path);

  document.getElementById("centerInput").value     = st.exam_center || "";
  document.getElementById("examDateInput").value   = st.exam_date || "";
  document.getElementById("examShiftInput").value  = st.exam_shift || "";
  document.getElementById("examStartInput").value  = st.exam_start_time || "";
  document.getElementById("examEndInput").value    = st.exam_end_time || "";
  document.getElementById("admitAllow").checked    = st.admit_allowed === true;

  document.getElementById("rMarks").value          = st.marks ?? "";
  document.getElementById("rRank").value           = st.rank ?? "";
  document.getElementById("rStatus").value         = st.result_status || "";
  document.getElementById("rPublish").checked      = st.result_published === true;
}

async function updateStatus(newStatus,payFlag){
  if(!currentId) return;
  const msg = document.getElementById("detailMsg");
  msg.textContent="Updating status...";

  const updateObj = {
    form_status: newStatus,
    payment_status: payFlag ? "approved" :
      (newStatus === "rejected" ? "rejected" : "pending")
  };

  const { error } = await sb
    .from("students")
    .update(updateObj)
    .eq("id",currentId);

  if(error){
    msg.style.color="red";
    msg.textContent="Error: "+error.message;
    return;
  }
  msg.style.color="green";
  msg.textContent="Status updated.";
  loadStudents();
  document.getElementById("dStatus").textContent=newStatus;
  document.getElementById("dPayment").textContent=payFlag?"approved":"pending";
}

async function saveCentreAdmit(){
  if(!currentId) return;
  const msg = document.getElementById("detailMsg");
  msg.style.color = "#000";
  msg.textContent = "Saving centre / admit...";

  const centre = document.getElementById("centerInput").value.trim();
  const date   = document.getElementById("examDateInput").value.trim();
  const shift  = document.getElementById("examShiftInput").value.trim();
  const start  = document.getElementById("examStartInput").value.trim();
  const end    = document.getElementById("examEndInput").value.trim();
  const allow  = document.getElementById("admitAllow").checked;

  const { error } = await sb
    .from("students")
    .update({
      exam_center: centre || null,
      exam_date: date || null,
      exam_shift: shift || null,
      exam_start_time: start || null,
      exam_end_time: end || null,
      admit_allowed: allow
    })
    .eq("id", currentId);

  if(error){
    msg.style.color="red";
    msg.textContent="Error saving centre/admit: "+error.message;
    return;
  }

  msg.style.color="green";
  msg.textContent="Centre / admit updated.";
  loadStudents();
}

async function saveResult(){
  if(!currentId) return;
  const msg = document.getElementById("detailMsg");
  msg.style.color = "#000";
  msg.textContent = "Saving result...";

  const marksVal  = document.getElementById("rMarks").value.trim();
  const rankVal   = document.getElementById("rRank").value.trim();
  const statusVal = document.getElementById("rStatus").value.trim();
  const publish   = document.getElementById("rPublish").checked;

  const { error } = await sb
    .from("students")
    .update({
      marks: marksVal === "" ? null : marksVal,
      rank:  rankVal === "" ? null : rankVal,
      result_status: statusVal || null,
      result_published: publish
    })
    .eq("id", currentId);

  if(error){
    msg.style.color="red";
    msg.textContent="Error saving result: "+error.message;
    return;
  }

  msg.style.color="green";
  msg.textContent="Result saved successfully.";
}

async function deleteStudent(st){
  const listMsg = document.getElementById("listMsg");
  if(!confirm(`Kya aap sure hain? Roll ${st.roll_number} ka form permanently delete ho jayega.`)){
    return;
  }

  listMsg.textContent = "Deleting record...";

  const { error } = await sb
    .from("students")
    .delete()
    .eq("id", st.id);

  if(error){
    listMsg.textContent = "Error deleting: " + error.message;
    return;
  }

  listMsg.textContent = "Record deleted.";
  if(currentId === st.id){
    currentId = null;
    document.getElementById("detailBox").style.display = "none";
  }
  loadStudents();
}
</script>

</body>
</html>
