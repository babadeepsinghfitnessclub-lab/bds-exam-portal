<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
.container{max-width:1100px;margin:15px auto;background:#fff;padding:15px;border-radius:8px}
h1{color:#b10000;margin:0 0 10px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
button{padding:5px 8px;border:none;border-radius:4px;cursor:pointer}
.view{background:#1976d2;color:#fff}
.del{background:#c62828;color:#fff}
.approve{background:#2e7d32;color:#fff}
.pending{background:#f9a825}
.reject{background:#d32f2f;color:#fff}
.box{background:#fafafa;border:1px solid #ccc;padding:10px;margin-top:10px;border-radius:6px}
input{width:100%;padding:4px;margin-top:3px}
label{font-size:13px;font-weight:bold}
.small{font-size:13px}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">

<a href="dashboard.html">← Admin Home</a>
<h1>Student Applications</h1>

<button onclick="downloadExcel()">⬇ Download Excel</button>
<p id="msg">Loading...</p>

<table>
<thead>
<tr>
<th>#</th>
<th>Roll</th>
<th>Name</th>
<th>Mobile</th>
<th>Exam Level</th>
<th>Form</th>
<th>Payment</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div id="details" class="box" style="display:none"></div>

</div>

<script>
if(localStorage.getItem("bdsAdminLoggedIn")!=="yes"){
  location.href="login.html";
}

const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL";
const SUPABASE_KEY = "PASTE_YOUR_PUBLISHABLE_KEY";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let current=null;

function fileLink(path){
  if(!path) return "Not uploaded";
  return `<a target="_blank" href="${sb.storage.from("student_docs").getPublicUrl(path).data.publicUrl}">Open</a>`;
}

async function load(){
  const {data,error}=await sb.from("students").select("*").order("created_at",{ascending:false});
  if(error){msg.textContent=error.message;return}
  list.innerHTML=""; msg.textContent="Loaded successfully";
  let i=1;
  data.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
    <td>${i++}</td>
    <td>${s.roll_number||""}</td>
    <td>${s.full_name||""}</td>
    <td>${s.mobile||""}</td>
    <td>${s.exam_level||""}</td>
    <td>${s.form_status||"pending"}</td>
    <td>${s.payment_status||"pending"}</td>
    <td>
      <button class="view" onclick="openDetails('${s.id}')">View</button>
      <button class="del" onclick="del('${s.id}','${s.roll_number}')">Delete</button>
    </td>`;
    list.appendChild(tr);
  });
}
load();

async function openDetails(id){
  const {data}=await sb.from("students").select("*").eq("id",id).single();
  current=data;
  details.style.display="block";
  details.innerHTML=`
<b>Name:</b> ${data.full_name}<br>
<b>Father:</b> ${data.father_name||""}<br>
<b>Mobile:</b> ${data.mobile}<br>
<b>Roll:</b> ${data.roll_number}<br>
<b>Exam Level:</b> ${data.exam_level||""}<br><br>

<b>Documents</b><br>
Photo: ${fileLink(data.photo_path)}<br>
Aadhaar Front: ${fileLink(data.aadhar_front_path)}<br>
Aadhaar Back: ${fileLink(data.aadhar_back_path)}<br>
Marksheet: ${fileLink(data.marksheet_path)}<br>
Payment SS: ${fileLink(data.payment_screenshot_path)}<br><br>

<b>Form / Payment</b><br>
<button class="approve" onclick="status('approved','approved')">Approve</button>
<button class="pending" onclick="status('pending','pending')">Pending</button>
<button class="reject" onclick="status('rejected','rejected')">Reject</button>

<hr>
<b>Admit Card</b>
<label>Centre</label><input id="c" value="${data.exam_center||""}">
<label>Date</label><input id="d" value="${data.exam_date||""}">
<label>Shift</label><input id="s" value="${data.exam_shift||""}">
<label>Start</label><input id="st" value="${data.exam_start_time||""}">
<label>End</label><input id="et" value="${data.exam_end_time||""}">
<button class="approve" onclick="saveAdmit()">Save Admit</button>

<hr>
<b>Result</b>
<label>Marks</label><input id="m" value="${data.marks||""}">
<label>Rank</label><input id="r" value="${data.rank||""}">
<label>Status</label><input id="rs" value="${data.result_status||""}">
<button class="approve" onclick="saveResult()">Save Result</button>
`;
}

async function status(f,p){
 await sb.from("students").update({form_status:f,payment_status:p}).eq("id",current.id);
 load();
}

async function saveAdmit(){
 await sb.from("students").update({
 exam_center:c.value,exam_date:d.value,exam_shift:s.value,
 exam_start_time:st.value,exam_end_time:et.value
 }).eq("id",current.id);
 alert("Admit saved");
}

async function saveResult(){
 await sb.from("students").update({
 marks:m.value,rank:r.value,result_status:rs.value
 }).eq("id",current.id);
 alert("Result saved");
}

async function del(id,roll){
 if(!confirm("Delete roll "+roll+" permanently?"))return;
 await sb.from("students").delete().eq("id",id);
 details.style.display="none";
 load();
}

async function downloadExcel(){
 const {data}=await sb.from("students").select("full_name,roll_number,mobile");
 const ws=XLSX.utils.json_to_sheet(data);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Students");
 XLSX.writeFile(wb,"students.xlsx");
}
</script>
</body>
</html>
