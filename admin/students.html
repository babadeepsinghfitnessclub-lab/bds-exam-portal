<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
.container{max-width:1100px;margin:15px auto;background:#fff;padding:15px;border-radius:8px}
h1{color:#b20c0c;margin:0 0 10px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eee}
button{padding:5px 8px;border:0;border-radius:4px;cursor:pointer}
.view{background:#1976d2;color:#fff}
.del{background:#c62828;color:#fff}
#detail{margin-top:15px;padding:10px;border:1px solid #ccc;background:#fafafa;display:none}
a{color:#1976d2}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">

<a href="dashboard.html">← Admin Home</a>
<button onclick="downloadExcel()" style="float:right">Download Excel</button>

<h1>Student Applications</h1>
<p id="msg">Loading...</p>

<table>
<thead>
<tr>
<th>#</th>
<th>Roll</th>
<th>Name</th>
<th>Mobile</th>
<th>Exam Level</th>
<th>Centre</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div id="detail">
<h3>Student Details</h3>
<p><b>Name:</b> <span id="dName"></span></p>
<p><b>Father:</b> <span id="dFather"></span></p>
<p><b>Mobile:</b> <span id="dMobile"></span></p>
<p><b>Roll:</b> <span id="dRoll"></span></p>
<p><b>Exam Level:</b> <span id="dExamLevel"></span></p>

<p><b>Photo:</b> <a id="dPhoto" target="_blank">Open</a></p>
<p><b>Aadhaar Front:</b> <a id="dAF" target="_blank">Open</a></p>
<p><b>Aadhaar Back:</b> <a id="dAB" target="_blank">Open</a></p>
<p><b>Marksheet:</b> <a id="dMS" target="_blank">Open</a></p>

<button class="del" onclick="deleteStudent()">Delete Permanently</button>
</div>

</div>

<script>
const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
const SUPABASE_KEY = "PASTE_YOUR_ANON_KEY_HERE";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentId = null;

function file(path){
 if(!path) return "";
 return sb.storage.from("student_docs").getPublicUrl(path).data.publicUrl;
}

async function load(){
 const {data,error} = await sb.from("students").select("*").order("id");
 if(error){ msg.innerText = error.message; return; }

 const tb = document.getElementById("list");
 tb.innerHTML="";
 let i=1;

 data.forEach(st=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`
   <td>${i++}</td>
   <td>${st.roll_number||""}</td>
   <td>${st.full_name||""}</td>
   <td>${st.mobile||""}</td>
   <td>${st.exam_level||""}</td>
   <td>${st.exam_center||""}</td>
   <td>${st.form_status||""}</td>
   <td>
    <button class="view">View</button>
    <button class="del">Delete</button>
   </td>`;
  tr.querySelector(".view").onclick=()=>openDetail(st);
  tr.querySelector(".del").onclick=()=>delRow(st.id);
  tb.appendChild(tr);
 });

 msg.innerText="Loaded successfully";
}
load();

function openDetail(st){
 currentId=st.id;
 detail.style.display="block";
 dName.innerText=st.full_name||"";
 dFather.innerText=st.father_name||"";
 dMobile.innerText=st.mobile||"";
 dRoll.innerText=st.roll_number||"";
 dExamLevel.innerText=st.exam_level||"";

 dPhoto.href=file(st.photo_path);
 dAF.href=file(st.aadhar_front_path);
 dAB.href=file(st.aadhar_back_path);
 dMS.href=file(st.marksheet_path);
}

async function delRow(id){
 if(!confirm("Permanent delete?")) return;
 await sb.from("students").delete().eq("id",id);
 load();
 detail.style.display="none";
}

async function deleteStudent(){
 if(!currentId) return;
 await sb.from("students").delete().eq("id",currentId);
 load();
 detail.style.display="none";
}

async function downloadExcel(){
 const {data}=await sb.from("students")
 .select("full_name,roll_number,mobile");

 const sheet=XLSX.utils.json_to_sheet(data.map(r=>({
  Name:r.full_name,
  Roll:r.roll_number,
  Mobile:r.mobile
 })));

 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,sheet,"Students");
 XLSX.writeFile(wb,"students.xlsx");
}
</script>
</body>
</html>
