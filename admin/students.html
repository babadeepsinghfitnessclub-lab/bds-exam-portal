<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
.container{max-width:1100px;margin:15px auto;background:#fff;padding:15px;border-radius:8px}
h1{color:#b20c0c;margin:0 0 10px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eee}
button{padding:5px 8px;border:none;border-radius:4px;cursor:pointer}
.view{background:#1976d2;color:#fff}
.del{background:#c62828;color:#fff}
.approve{background:#2e7d32;color:#fff}
.pending{background:#ffa000}
.reject{background:#c62828;color:#fff}
.section{margin-top:12px;border-top:1px solid #ccc;padding-top:8px}
label{font-size:13px}
input{width:100%;padding:5px;margin-top:2px}
.msg{font-size:13px;margin-top:6px}
a{color:#1976d2}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">

<a href="dashboard.html">← Admin Home</a>
<h1>Student Applications</h1>

<button onclick="downloadExcel()">⬇ Download Excel</button>
<p id="listMsg">Loading...</p>

<table>
<thead>
<tr>
<th>#</th>
<th>Roll</th>
<th>Name</th>
<th>Mobile</th>
<th>Exam Level</th>
<th>Form</th>
<th>Payment</th>
<th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="detailBox" style="display:none">

<div class="section">
<b>Name:</b> <span id="dName"></span><br>
<b>Father:</b> <span id="dFather"></span><br>
<b>Mobile:</b> <span id="dMobile"></span><br>
<b>Roll:</b> <span id="dRoll"></span><br>
<b>Exam Level:</b> <span id="dLevel"></span><br>
<b>Status:</b> <span id="dStatus"></span><br>
<b>Payment:</b> <span id="dPayment"></span>
</div>

<div class="section">
<b>Documents</b><br>
Photo: <a id="dPhoto" target="_blank"></a><br>
Aadhaar Front: <a id="dAF" target="_blank"></a><br>
Aadhaar Back: <a id="dAB" target="_blank"></a><br>
Marksheet: <a id="dMS" target="_blank"></a><br>
Payment SS: <a id="dPSS" target="_blank"></a>
</div>

<div class="section">
<button class="approve" onclick="setStatus('approved',true)">Approve</button>
<button class="pending" onclick="setStatus('pending',false)">Pending</button>
<button class="reject" onclick="setStatus('rejected',false)">Reject</button>
</div>

<p class="msg" id="dMsg"></p>
</div>

</div>

<script>
const sb = supabase.createClient(
 "https://yyymjhuwjvyykukfzqow.supabase.co",
 "sb_publishable_AotK9XHnYF0UmfJYrS7GCg_BHXVvzy0"
);

let currentId=null;

function setLink(a, path){
 if(!path){
   a.innerText="Not uploaded";
   a.removeAttribute("href");
   a.style.pointerEvents="none";
   a.style.opacity="0.6";
   return;
 }
 const url = sb.storage.from("student_docs").getPublicUrl(path).data.publicUrl;
 a.href = url;
 a.innerText = "Open";
 a.style.pointerEvents="auto";
 a.style.opacity="1";
}

async function load(){
 const {data}=await sb.from("students").select("*").order("created_at",{ascending:false});
 tbody.innerHTML="";
 let i=1;
 data.forEach(s=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`
   <td>${i++}</td>
   <td>${s.roll_number||""}</td>
   <td>${s.full_name || s.name || ""}</td>
   <td>${s.mobile||""}</td>
   <td>${s.exam_level||""}</td>
   <td>${s.form_status||"pending"}</td>
   <td>${s.payment_status||"pending"}</td>
   <td>
    <button class="view">View</button>
    <button class="del">Delete</button>
   </td>`;
  tr.querySelector(".view").onclick=()=>open(s);
  tr.querySelector(".del").onclick=()=>del(s.id);
  tbody.appendChild(tr);
 });
 listMsg.innerText="Loaded";
}
load();

function open(s){
 currentId=s.id;
 detailBox.style.display="block";
 dName.innerText = s.full_name || s.name || "";
 dFather.innerText = s.father_name || "";
 dMobile.innerText = s.mobile || "";
 dRoll.innerText = s.roll_number || "";
 dLevel.innerText = s.exam_level || "";
 dStatus.innerText = s.form_status || "";
 dPayment.innerText = s.payment_status || "";

 setLink(dPhoto, s.photo_path);
 setLink(dAF, s.aadhar_front_path);
 setLink(dAB, s.aadhar_back_path);
 setLink(dMS, s.marksheet_path);
 setLink(dPSS, s.payment_screenshot_path);
}

async function setStatus(st,pay){
 await sb.from("students").update({
  form_status:st,
  payment_status:pay?"approved":"pending"
 }).eq("id",currentId);
 load();
}

async function del(id){
 if(!confirm("Permanent delete?"))return;
 await sb.from("students").delete().eq("id",id);
 load();
}

async function downloadExcel(){
 const {data}=await sb.from("students").select("full_name,roll_number,mobile");
 const ws=XLSX.utils.json_to_sheet(data);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Students");
 XLSX.writeFile(wb,"students.xlsx");
}
</script>
</body>
</html>
