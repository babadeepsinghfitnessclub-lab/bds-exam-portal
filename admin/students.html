<script>
const sb = supabase.createClient(
 "https://yyymjhuwjvyykukfzqow.supabase.co",
 "sb_publishable_AotK9XHnYF0UmfJYrS7GCg_BHXVvzy0"
);

let currentId = null;

/* ---------- PUBLIC FILE URL ---------- */
function pub(path){
 if(!path) return null;
 const { data } = sb.storage.from("student_docs").getPublicUrl(path);
 return data?.publicUrl || null;
}

/* ---------- LOAD STUDENTS ---------- */
async function load(){
 const { data, error } = await sb
   .from("students")
   .select("*")
   .order("created_at", { ascending:false });

 if(error){
   listMsg.innerText = error.message;
   return;
 }

 tbody.innerHTML = "";
 let i = 1;

 data.forEach(s=>{
  const studentName = s.full_name || s.name || "";

  const tr = document.createElement("tr");
  tr.innerHTML = `
   <td>${i++}</td>
   <td>${s.roll_number || ""}</td>
   <td>${studentName}</td>
   <td>${s.mobile || ""}</td>
   <td>${s.exam_level || ""}</td>
   <td>${s.form_status || "pending"}</td>
   <td>${s.payment_status || "pending"}</td>
   <td>
     <button class="view">View</button>
     <button class="del">Delete</button>
   </td>
  `;

  tr.querySelector(".view").onclick = () => openDetail(s);
  tr.querySelector(".del").onclick = () => delRow(s.id);

  tbody.appendChild(tr);
 });

 listMsg.innerText = "Loaded";
}

load();

/* ---------- SET DOCUMENT LINKS ---------- */
function setLink(el, path){
 const url = pub(path);
 if(url){
   el.href = url;
   el.innerText = "Open";
   el.style.pointerEvents = "auto";
 }else{
   el.removeAttribute("href");
   el.innerText = "Not uploaded";
   el.style.pointerEvents = "none";
 }
}

/* ---------- OPEN DETAILS ---------- */
function openDetail(s){
 currentId = s.id;   // âœ… VERY IMPORTANT

 detailBox.style.display = "block";

 dName.innerText   = s.full_name || s.name || "";
 dFather.innerText = s.father_name || "";
 dMobile.innerText = s.mobile || "";
 dRoll.innerText   = s.roll_number || "";
 dLevel.innerText  = s.exam_level || "";
 dStatus.innerText = s.form_status || "";
 dPayment.innerText= s.payment_status || "";

 setLink(dPhoto, s.photo_path);
 setLink(dAF, s.aadhar_front_path);
 setLink(dAB, s.aadhar_back_path);
 setLink(dMS, s.marksheet_path);
 setLink(dPSS, s.payment_screenshot_path);
}

/* ---------- APPROVE / PENDING / REJECT ---------- */
async function setStatus(status, payment){
 if(!currentId){
   alert("Please click VIEW first");
   return;
 }

 const { error } = await sb
   .from("students")
   .update({
     form_status: status,
     payment_status: payment ? "approved" : "pending"
   })
   .eq("id", currentId);

 if(error){
   alert(error.message);
 }else{
   load();
   alert("Status updated");
 }
}

/* ---------- DELETE ---------- */
async function delRow(id){
 if(!confirm("Permanent delete?")) return;
 await sb.from("students").delete().eq("id", id);
 load();
}

/* ---------- EXCEL ---------- */
async function downloadExcel(){
 const { data } = await sb
  .from("students")
  .select("full_name,name,roll_number,mobile");

 const fixed = data.map(s=>({
  Name: s.full_name || s.name || "",
  Roll: s.roll_number,
  Mobile: s.mobile
 }));

 const ws = XLSX.utils.json_to_sheet(fixed);
 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "Students");
 XLSX.writeFile(wb, "students.xlsx");
}
</script>
