<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; }
  .container {
    max-width: 1000px;
    margin: 15px auto;
    background:#fff;
    padding: 12px 15px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  h1 { margin-top:0; color:#b20c0c; }
  table {
    width:100%; border-collapse: collapse; margin-top:10px; font-size:13px;
  }
  th, td {
    border:1px solid #ddd; padding:6px; text-align:left;
  }
  th { background:#eee; }
  tr:nth-child(even){ background:#fafafa; }
  button {
    padding:5px 8px; border:none; border-radius:4px;
    cursor:pointer; font-size:12px; margin:2px;
  }
  .btn-view { background:#1976d2; color:#fff; }
  .btn-approve { background:#2e7d32; color:#fff; }
  .btn-pending { background:#ffa000; color:#000; }
  .btn-reject { background:#c62828; color:#fff; }
  .msg { margin-top:6px; font-size:13px; }
  .detail-card {
    margin-top:12px;
    padding:10px;
    border-radius:6px;
    background:#fafafa;
    border:1px solid #ddd;
    font-size:14px;
  }
  .field-label { font-weight:bold; }
  a { color:#1976d2; }
  .topbar-links a { margin-right:8px; font-size:13px; }
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <div class="topbar-links">
    <a href="dashboard.html">← Admin Home</a> |
    <a href="../index.html" target="_blank">Open Website</a>
  </div>

  <h1>Student Applications</h1>

  <p class="msg" id="listMsg">Loading...</p>

  <table id="appsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Mobile</th>
        <th>Status</th>
        <th>Payment</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="appsBody"></tbody>
  </table>

  <div id="detailBox" class="detail-card" style="display:none;">
    <p><span class="field-label">Name:</span> <span id="dName"></span></p>
    <p><span class="field-label">Father:</span> <span id="dFather"></span></p>
    <p><span class="field-label">Mobile:</span> <span id="dMobile"></span></p>
    <p><span class="field-label">Roll No:</span> <span id="dRoll"></span></p>
    <p><span class="field-label">Status:</span> <span id="dStatus"></span></p>
    <p><span class="field-label">Payment Status:</span> <span id="dPayment"></span></p>
    <p><span class="field-label">UPI Txn ID:</span> <span id="dTxn"></span></p>
    <p><span class="field-label">Address:</span> <span id="dAddress"></span></p>
    <p><span class="field-label">Qualification:</span> <span id="dQual"></span></p>
    
    <p><span class="field-label">Photo:</span> <a id="dPhoto" target="_blank">Open</a></p>
    <p><span class="field-label">Aadhaar Front:</span> <a id="dAadharF" target="_blank">Open</a></p>
    <p><span class="field-label">Aadhaar Back:</span> <a id="dAadharB" target="_blank">Open</a></p>
    <p><span class="field-label">Marksheet:</span> <a id="dMarksheet" target="_blank">Open</a></p>
    <p><span class="field-label">Payment Screenshot:</span> <a id="dPaymentSS" target="_blank">Open</a></p>

    <div style="margin-top:10px;">
      <button class="btn-approve" onclick="updateStatus('Approved', true)">Approve</button>
      <button class="btn-pending" onclick="updateStatus('Pending', false)">Pending</button>
      <button class="btn-reject" onclick="updateStatus('Rejected', false)">Reject</button>
    </div>

    <p class="msg" id="detailMsg"></p>
  </div>

</div>

<script>
if(localStorage.getItem("bdsAdminLoggedIn")!=="yes"){
  window.location.href="login.html";
}

const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eW1qaHV3anZ5eWt1a2Z6cW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMzMjIsImV4cCI6MjA4MDI0OTMyMn0.Ja9Do4cwumTnXx2NGIRW8Ti3rKm4MBiLClQz0xjOtrQ";

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentId = null;
let currentData = null;

async function loadStudents(){
  listMsg.textContent = "Loading...";
  const { data, error } = await sb
    .from("students")
    .select("*")
    .order("created_at",{ ascending: false });

  if(error){
    listMsg.textContent = "Error: "+error.message;
    return;
  }

  const body = document.getElementById("appsBody");
  body.innerHTML = "";
  let i=1;

  data.forEach(st=>{
    if(!st.roll_number) return;
    const tr = document.createElement("tr");

    tr.innerHTML =
      `<td>${i++}</td>
       <td>${st.roll_number}</td>
       <td>${st.name}</td>
       <td>${st.mobile}</td>
       <td>${st.status || "Pending"}</td>
       <td>${st.payment_verified ? "Approved" : "Pending"}</td>
       <td><button class='btn-view'>View</button></td>`;

    tr.querySelector("button").onclick = ()=>openDetails(st);
    body.appendChild(tr);
  });

  listMsg.textContent = "Loaded successfully.";
}
loadStudents();

function openDetails(st){
  currentId = st.id;
  currentData = st;

  document.getElementById("detailBox").style.display="block";
  document.getElementById("detailMsg").textContent = "";

  document.getElementById("dName").textContent = st.name;
  document.getElementById("dFather").textContent = st.father_name;
  document.getElementById("dMobile").textContent = st.mobile;
  document.getElementById("dRoll").textContent = st.roll_number;
  document.getElementById("dStatus").textContent = st.status || "Pending";
  document.getElementById("dPayment").textContent = st.payment_verified?"Approved":"Pending";
  document.getElementById("dTxn").textContent = st.txn_id;
  document.getElementById("dAddress").textContent = st.address;
  document.getElementById("dQual").textContent = st.qualification;

  document.getElementById("dPhoto").href = st.photo_url;
  document.getElementById("dAadharF").href = st.aadhar_front;
  document.getElementById("dAadharB").href = st.aadhar_back;
  document.getElementById("dMarksheet").href = st.marksheet_url;
  document.getElementById("dPaymentSS").href = st.payment_ss;
}

async function updateStatus(newStatus,payFlag){
  if(!currentId) return;
  const msg = document.getElementById("detailMsg");
  msg.textContent="Updating...";
  const { error } = await sb
    .from("students")
    .update({
      status:newStatus,
      payment_verified:payFlag
    })
    .eq("id",currentId);

  if(error){
    msg.style.color="red";
    msg.textContent="Error: "+error.message;
    return;
  }
  msg.style.color="green";
  msg.textContent="Updated successfully.";
  loadStudents();
  document.getElementById("dStatus").textContent=newStatus;
  document.getElementById("dPayment").textContent=payFlag?"Approved":"Pending";
}
</script>

</body>
</html>
