<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; }
  .container {
    max-width: 1000px;
    margin: 15px auto;
    background:#fff;
    padding: 12px 15px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  h1 { margin-top:0; color:#b20c0c; }
  table {
    width:100%; border-collapse: collapse; margin-top:10px; font-size:13px;
  }
  th, td {
    border:1px solid #ddd; padding:6px; text-align:left;
  }
  th { background:#eee; }
  tr:nth-child(even){ background:#fafafa; }
  button {
    padding:5px 8px; border:none; border-radius:4px;
    cursor:pointer; font-size:12px; margin:2px;
  }
  .btn-view { background:#1976d2; color:#fff; }
  .btn-approve { background:#2e7d32; color:#fff; }
  .btn-pending { background:#ffa000; color:#000; }
  .btn-reject { background:#c62828; color:#fff; }
  .btn-delete { background:#b71c1c; color:#fff; }
  .msg { margin-top:6px; font-size:13px; }
  .detail-card {
    margin-top:12px;
    padding:10px;
    border-radius:6px;
    background:#fafafa;
    border:1px solid #ddd;
    font-size:14px;
  }
  .field-label { font-weight:bold; }
  a { color:#1976d2; }
  .topbar-links a { margin-right:8px; font-size:13px; }

  .section-title{
    margin-top:10px;
    font-weight:bold;
    border-bottom:1px solid #ccc;
    padding-bottom:3px;
    margin-bottom:4px;
  }
  .row-2col{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .row-2col > div{
    flex:1 1 160px;
  }
  input[type="text"], input[type="number"]{
    width:100%;
    padding:4px 6px;
    margin-top:2px;
    box-sizing:border-box;
    border-radius:4px;
    border:1px solid #ccc;
    font-size:13px;
  }
  label{font-size:13px;}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <div class="topbar-links">
    <a href="dashboard.html">← Admin Home</a> |
    <a href="../index.html" target="_blank">Open Website</a>
  </div>

  <h1>Student Applications</h1>

  <p class="msg" id="listMsg">Loading...</p>

  <table id="appsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Mobile</th>
        <th>Centre</th>
        <th>Form Status</th>
        <th>Payment</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="appsBody"></tbody>
  </table>

  <!-- DETAIL CARD -->
  <div id="detailBox" class="detail-card" style="display:none;">
    <div class="section-title">Student Details</div>
    <p><span class="field-label">Name:</span> <span id="dName"></span></p>
    <p><span class="field-label">Father:</span> <span id="dFather"></span></p>
    <p><span class="field-label">Mobile:</span> <span id="dMobile"></span></p>
    <p><span class="field-label">Roll No:</span> <span id="dRoll"></span></p>
    <p><span class="field-label">Form Status:</span> <span id="dFormStatus"></span></p>
    <p><span class="field-label">Payment Status:</span> <span id="dPayStatus"></span></p>
    <p><span class="field-label">UPI Txn ID:</span> <span id="dUpi"></span></p>
    <p><span class="field-label">Address:</span> <span id="dAddress"></span></p>
    <p><span class="field-label">Qualification:</span> <span id="dQual"></span></p>

    <div class="section-title">Documents</div>
    <p>Photo: <a href="#" id="docPhoto" target="_blank">Open</a></p>
    <p>Aadhaar Front: <a href="#" id="docAf" target="_blank">Open</a></p>
    <p>Aadhaar Back: <a href="#" id="docAb" target="_blank">Open</a></p>
    <p>Marksheet: <a href="#" id="docMark" target="_blank">Open</a></p>
    <p>Payment Screenshot: <a href="#" id="docPay" target="_blank">Open</a></p>

    <div class="section-title">Payment / Form Status</div>
    <button class="btn-approve" onclick="setStatus('approved')">Approve</button>
    <button class="btn-pending" onclick="setStatus('pending')">Pending</button>
    <button class="btn-reject" onclick="setStatus('rejected')">Reject</button>

    <div class="section-title">Exam Centre & Admit Card</div>
    <label>Exam Centre (school / city etc.)</label>
    <input type="text" id="centreInput" placeholder="Exam centre">
    <label style="margin-top:6px;">
      <input type="checkbox" id="admitCheck">
      Admit card active kare? (payment approved + ye tick ⇒ student admit card download kar sakta hai)
    </label>
    <button onclick="saveCentreAdmit()">Save Centre / Admit</button>

    <div class="section-title">Result Update</div>
    <div class="row-2col">
      <div>
        <label>Marks</label>
        <input type="number" id="marksInput" placeholder="Marks">
      </div>
      <div>
        <label>Rank</label>
        <input type="number" id="rankInput" placeholder="Rank">
      </div>
    </div>
    <label style="margin-top:6px;">Result Status</label>
    <input type="text" id="resultStatusInput" placeholder="Jaise: Pass / Fail / Absent">
    <label style="margin-top:6px;">
      <input type="checkbox" id="resultPublishCheck">
      Result publish kare? (website par show hoga)
    </label>
    <button onclick="saveResult()">Save Result</button>

    <div class="section-title">Danger Zone</div>
    <p style="font-size:12px;color:#b71c1c;">
      Yahan se pura student application delete ho jayega (saare documents ke saath). Dhyan se use karein.
    </p>
    <button class="btn-delete" onclick="deleteCurrentStudent()">Delete Application</button>

    <p class="msg" id="detailMsg"></p>
  </div>
</div>

<script>
  // ---------- CONFIG ----------
  const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eW1qaHV3anZ5eWt1a2Z6cW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMzMjIsImV4cCI6MjA4MDI0OTMyMn0.Ja9Do4cwumTnXx2NGIRW8Ti3rKm4MBiLClQz0xjOtrQ";

  const STUDENT_DOC_BUCKET = "student_docs"; // agar bucket ka naam kuch aur hai to yahan change karo

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // admin login check
  if (localStorage.getItem("bdsAdminLoggedIn") !== "yes") {
    window.location.href = "login.html";
  }

  const listMsg    = document.getElementById("listMsg");
  const appsBody   = document.getElementById("appsBody");
  const detailBox  = document.getElementById("detailBox");
  const detailMsg  = document.getElementById("detailMsg");

  let allStudents = [];
  let currentStudent = null;

  // ---------- LOAD LIST ----------
  async function loadApplications() {
    listMsg.textContent = "Loading...";
    appsBody.innerHTML = "";

    const { data, error } = await sb
      .from("students")
      .select("id, roll_number, full_name, father_name, mobile, upi_txn, address, qualification, form_status, payment_status, exam_centre, admit_active, photo_path, aadhar_front_path, aadhar_back_path, marksheet_path, payment_screenshot_path, marks, rank, result_status, result_published")
      .order("id", { ascending: true });

    if (error) {
      console.error(error);
      listMsg.textContent = "Error loading applications: " + error.message;
      return;
    }

    allStudents = data;
    listMsg.textContent = "Loaded successfully.";

    data.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${row.roll_number || "-"}</td>
        <td>${row.full_name || ""}</td>
        <td>${row.mobile || ""}</td>
        <td>${row.exam_centre || "-"}</td>
        <td>${row.form_status || "-"}</td>
        <td>${row.payment_status || "-"}</td>
        <td><button class="btn-view" onclick="viewStudent(${row.id})">View</button></td>
      `;
      appsBody.appendChild(tr);
    });
  }

  // ---------- DETAIL FILL ----------
  window.viewStudent = function(id) {
    const row = allStudents.find(s => s.id === id);
    if (!row) return;

    currentStudent = row;
    detailMsg.textContent = "";

    document.getElementById("dName").textContent   = row.full_name || "";
    document.getElementById("dFather").textContent = row.father_name || "";
    document.getElementById("dMobile").textContent = row.mobile || "";
    document.getElementById("dRoll").textContent   = row.roll_number || "";
    document.getElementById("dFormStatus").textContent = row.form_status || "";
    document.getElementById("dPayStatus").textContent  = row.payment_status || "";
    document.getElementById("dUpi").textContent    = row.upi_txn || "";
    document.getElementById("dAddress").textContent= row.address || "";
    document.getElementById("dQual").textContent   = row.qualification || "";

    // docs – agar path nahi hai to link disable
    setDocLink("docPhoto", row.photo_path);
    setDocLink("docAf", row.aadhar_front_path);
    setDocLink("docAb", row.aadhar_back_path);
    setDocLink("docMark", row.marksheet_path);
    setDocLink("docPay", row.payment_screenshot_path);

    // centre / admit
    document.getElementById("centreInput").value = row.exam_centre || "";
    document.getElementById("admitCheck").checked = row.admit_active === true;

    // result
    document.getElementById("marksInput").value = row.marks ?? "";
    document.getElementById("rankInput").value  = row.rank ?? "";
    document.getElementById("resultStatusInput").value = row.result_status || "";
    document.getElementById("resultPublishCheck").checked = row.result_published === true;

    detailBox.style.display = "block";
    detailBox.scrollIntoView({ behavior:"smooth" });
  };

  function setDocLink(id, path) {
    const a = document.getElementById(id);
    if (path) {
      // public URL banane ki zarurat nahi, tumhare paths already public_url ho sakte
      // yahan assume kar rahe hain ki path me full URL stored nahi hai,
      // agar full URL hai to directly use karo.
      if (path.startsWith("http")) {
        a.href = path;
      } else {
        const { data } = sb.storage.from(STUDENT_DOC_BUCKET).getPublicUrl(path);
        a.href = data.publicUrl;
      }
      a.textContent = "Open";
    } else {
      a.href = "#";
      a.textContent = "N/A";
    }
  }

  // ---------- STATUS UPDATE ----------
  window.setStatus = async function(status){
    if (!currentStudent) return;
    detailMsg.style.color = "#000";
    detailMsg.textContent = "Saving status...";

    const { error } = await sb
      .from("students")
      .update({
        form_status: status,
        payment_status: status
      })
      .eq("id", currentStudent.id);

    if (error) {
      console.error(error);
      detailMsg.style.color = "red";
      detailMsg.textContent = "Error updating status: " + error.message;
      return;
    }

    detailMsg.style.color = "green";
    detailMsg.textContent = "Status updated.";
    await loadApplications();
    // refresh currentStudent from list
    const fresh = allStudents.find(s => s.id === currentStudent.id);
    if (fresh) currentStudent = fresh;
    document.getElementById("dFormStatus").textContent = currentStudent.form_status;
    document.getElementById("dPayStatus").textContent  = currentStudent.payment_status;
  };

  // ---------- CENTRE / ADMIT ----------
  window.saveCentreAdmit = async function() {
    if (!currentStudent) return;
    const centre = document.getElementById("centreInput").value.trim();
    const admit  = document.getElementById("admitCheck").checked;

    detailMsg.style.color = "#000";
    detailMsg.textContent = "Saving centre / admit...";

    const { error } = await sb
      .from("students")
      .update({
        exam_centre: centre || null,
        admit_active: admit
      })
      .eq("id", currentStudent.id);

    if (error) {
      console.error(error);
      detailMsg.style.color = "red";
      detailMsg.textContent = "Error saving centre: " + error.message;
      return;
    }

    detailMsg.style.color = "green";
    detailMsg.textContent = "Centre / Admit saved.";
    await loadApplications();
  };

  // ---------- RESULT ----------
  window.saveResult = async function() {
    if (!currentStudent) return;
    const marks  = document.getElementById("marksInput").value;
    const rank   = document.getElementById("rankInput").value;
    const status = document.getElementById("resultStatusInput").value.trim();
    const publish= document.getElementById("resultPublishCheck").checked;

    detailMsg.style.color = "#000";
    detailMsg.textContent = "Saving result...";

    const payload = {
      result_status: status || null,
      result_published: publish
    };
    payload.marks = marks !== "" ? Number(marks) : null;
    payload.rank  = rank  !== "" ? Number(rank)  : null;

    const { error } = await sb
      .from("students")
      .update(payload)
      .eq("id", currentStudent.id);

    if (error) {
      console.error(error);
      detailMsg.style.color = "red";
      detailMsg.textContent = "Error saving result: " + error.message;
      return;
    }

    detailMsg.style.color = "green";
    detailMsg.textContent = "Result updated.";
    await loadApplications();
  };

  // ---------- DELETE APPLICATION ----------
  window.deleteCurrentStudent = async function() {
    if (!currentStudent) return;

    const sure = confirm(
      "Kya aap pakka is student ka pura application delete karna chahte hain?\n" +
      "Saare documents bhi delete ho jayenge."
    );
    if (!sure) return;

    detailMsg.style.color = "#000";
    detailMsg.textContent = "Deleting application...";

    try {
      // 1) delete documents from storage (best-effort)
      const paths = [
        currentStudent.photo_path,
        currentStudent.aadhar_front_path,
        currentStudent.aadhar_back_path,
        currentStudent.marksheet_path,
        currentStudent.payment_screenshot_path
      ].filter(p => !!p && !p.startsWith("http")); // sirf path wale

      if (paths.length > 0) {
        const { error: delErr } = await sb
          .storage
          .from(STUDENT_DOC_BUCKET)
          .remove(paths);

        if (delErr) {
          console.warn("Doc delete error:", delErr.message);
          // yaha par sirf warn kar rahe, process rok nahi rahe
        }
      }

      // 2) delete row from students
      const { error: rowErr } = await sb
        .from("students")
        .delete()
        .eq("id", currentStudent.id);

      if (rowErr) {
        throw rowErr;
      }

      detailMsg.style.color = "green";
      detailMsg.textContent = "Application deleted.";
      detailBox.style.display = "none";
      currentStudent = null;
      await loadApplications();

    } catch (err) {
      console.error(err);
      detailMsg.style.color = "red";
      detailMsg.textContent = "Error deleting application: " + err.message;
    }
  };

  // initial load
  loadApplications();
</script>

</body>
</html>
