<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
.container{max-width:1100px;margin:15px auto;background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
h1{color:#b20c0c;margin:5px 0}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eee}
button{padding:5px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px}
.view{background:#1976d2;color:#fff}
.del{background:#c62828;color:#fff}
.ok{background:#2e7d32;color:#fff}
.pen{background:#ffa000}
.card{margin-top:15px;border:1px solid #ddd;padding:12px;border-radius:6px;background:#fafafa}
label{font-size:13px;font-weight:bold}
input{width:100%;padding:5px;margin:3px 0}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>

<div class="container">
<a href="dashboard.html">← Admin Home</a>
<h1>Student Applications</h1>

<button onclick="downloadExcel()">⬇ Download Excel</button>
<p id="msg">Loading...</p>

<table>
<thead>
<tr>
<th>#</th>
<th>Roll</th>
<th>Name</th>
<th>Mobile</th>
<th>Exam Level</th>
<th>Centre</th>
<th>Form</th>
<th>Payment</th>
<th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="details" class="card" style="display:none"></div>
</div>

<script>
const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
const SUPABASE_KEY = "sb_publishable_AotK9XHnYF0UmfJYrS7GCg_BHXVvzy0";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let current = null;

function fileURL(p){
 if(!p) return null;
 return sb.storage.from("student_docs").getPublicUrl(p).data.publicUrl;
}

async function load(){
 const {data,error} = await sb.from("students").select("*").order("created_at",{ascending:false});
 if(error){msg.innerText=error.message;return;}
 msg.innerText="Loaded successfully";
 tbody.innerHTML="";
 let i=1;
 data.forEach(s=>{
  if(!s.roll_number) return;
  tbody.innerHTML+=`
  <tr>
   <td>${i++}</td>
   <td>${s.roll_number}</td>
   <td>${s.full_name||""}</td>
   <td>${s.mobile||""}</td>
   <td>${s.exam_level||""}</td>
   <td>${s.exam_center||""}</td>
   <td>${s.form_status||"pending"}</td>
   <td>${s.payment_status||"pending"}</td>
   <td>
    <button class="view" onclick='open(${JSON.stringify(s)})'>View</button>
    <button class="del" onclick="del('${s.id}','${s.roll_number}')">Delete</button>
   </td>
  </tr>`;
 });
}
load();

function open(s){
 current=s;
 details.style.display="block";
 details.innerHTML=`
 <b>Name:</b> ${s.full_name}<br>
 <b>Father:</b> ${s.father_name||""}<br>
 <b>Mobile:</b> ${s.mobile}<br>
 <b>Roll:</b> ${s.roll_number}<br>
 <b>Exam Level:</b> ${s.exam_level||""}<br><br>

 <b>Documents</b><br>
 Photo: ${link(s.photo_path)}<br>
 Aadhaar Front: ${link(s.aadhar_front_path)}<br>
 Aadhaar Back: ${link(s.aadhar_back_path)}<br>
 Marksheet: ${link(s.marksheet_path)}<br>
 Payment SS: ${link(s.payment_screenshot_path)}<br><br>

 <button class="ok" onclick="status('approved','approved')">Approve</button>
 <button class="pen" onclick="status('pending','pending')">Pending</button>
 <button class="del" onclick="status('rejected','rejected')">Reject</button>

 <hr>
 <label>Centre</label>
 <input id="c" value="${s.exam_center||""}">
 <label>Date</label>
 <input id="d" value="${s.exam_date||""}">
 <label>Shift</label>
 <input id="sh" value="${s.exam_shift||""}">
 <label>Start</label>
 <input id="st" value="${s.exam_start_time||""}">
 <label>End</label>
 <input id="et" value="${s.exam_end_time||""}">
 <button class="ok" onclick="saveCentre()">Save Admit</button>

 <hr>
 <label>Marks</label>
 <input id="m" value="${s.marks||""}">
 <label>Rank</label>
 <input id="r" value="${s.rank||""}">
 <label>Status</label>
 <input id="rs" value="${s.result_status||""}">
 <button class="ok" onclick="saveResult()">Save Result</button>
 `;
}

function link(p){
 if(!p) return "Not uploaded";
 return `<a href="${fileURL(p)}" target="_blank">Open</a>`;
}

async function status(f,p){
 await sb.from("students").update({form_status:f,payment_status:p}).eq("id",current.id);
 load();
}

async function saveCentre(){
 await sb.from("students").update({
  exam_center:c.value,
  exam_date:d.value,
  exam_shift:sh.value,
  exam_start_time:st.value,
  exam_end_time:et.value,
  admit_allowed:true
 }).eq("id",current.id);
 alert("Admit saved");
}

async function saveResult(){
 await sb.from("students").update({
  marks:m.value||null,
  rank:r.value||null,
  result_status:rs.value,
  result_published:true
 }).eq("id",current.id);
 alert("Result saved");
}

async function del(id,roll){
 if(!confirm("Delete Roll "+roll+" permanently?")) return;
 await sb.from("students").delete().eq("id",id);
 details.style.display="none";
 load();
}

async function downloadExcel(){
 const {data}=await sb.from("students").select("full_name,roll_number,mobile");
 const ws=XLSX.utils.json_to_sheet(data.map(d=>({
  Name:d.full_name,
  Roll:d.roll_number,
  Mobile:d.mobile
 })));
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Students");
 XLSX.writeFile(wb,"students.xlsx");
}
</script>
</body>
</html>
