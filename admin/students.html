<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Student Applications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
.container{max-width:1000px;margin:15px auto;background:#fff;padding:12px 15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
h1{margin:0;color:#b20c0c}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eee}
button{padding:5px 8px;border:none;border-radius:4px;font-size:12px;cursor:pointer}
.btn-view{background:#1976d2;color:#fff}
.btn-reject{background:#c62828;color:#fff}
.btn-approve{background:#2e7d32;color:#fff}
.msg{font-size:13px;margin-top:5px}
.detail-card{margin-top:10px;padding:10px;background:#fafafa;border:1px solid #ddd;border-radius:6px}
.field-label{font-weight:bold}
a{color:#1976d2}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="container">
  <a href="dashboard.html">← Admin Home</a> |
  <a href="../index.html" target="_blank">Open Website</a>

  <h1>Student Applications</h1>
  <p class="msg" id="msg">Loading...</p>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Mobile</th>
        <th>Exam Level</th>
        <th>Centre</th>
        <th>Form</th>
        <th>Payment</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="details" class="detail-card" style="display:none">
    <p><span class="field-label">Name:</span> <span id="dName"></span></p>
    <p><span class="field-label">Father:</span> <span id="dFather"></span></p>
    <p><span class="field-label">Mobile:</span> <span id="dMobile"></span></p>
    <p><span class="field-label">Roll:</span> <span id="dRoll"></span></p>
    <p><span class="field-label">Exam Level:</span> <span id="dExam"></span></p>
    <p><span class="field-label">Status:</span> <span id="dStatus"></span></p>

    <p><span class="field-label">Photo:</span> <a id="dPhoto" target="_blank">Open</a></p>
    <p><span class="field-label">Aadhaar Front:</span> <a id="dAF" target="_blank">Open</a></p>
    <p><span class="field-label">Aadhaar Back:</span> <a id="dAB" target="_blank">Open</a></p>
    <p><span class="field-label">Marksheet:</span> <a id="dM" target="_blank">Open</a></p>

    <button class="btn-approve" onclick="setStatus('approved')">Approve</button>
    <button class="btn-reject" onclick="setStatus('rejected')">Reject</button>
  </div>
</div>

<script>
if(localStorage.getItem("bdsAdminLoggedIn")!=="yes"){
  location.href="login.html";
}

const sb = supabase.createClient(
  "https://yyymjhuwjvyykukfzqow.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eW1qaHV3anZ5eWt1a2Z6cW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMzMjIsImV4cCI6MjA4MDI0OTMyMn0.Ja9Do4cwumTnXx2NGIRW8Ti3rKm4MBiLClQz0xjOtrQ"
);

let currentId=null;

async function load(){
  const {data,error}=await sb.from("students").select("*").order("created_at",{ascending:false});
  if(error){msg.textContent=error.message;return}
  tbody.innerHTML="";
  let i=1;
  data.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i++}</td>
      <td>${s.roll_number||""}</td>
      <td>${s.full_name||""}</td>
      <td>${s.mobile||""}</td>
      <td>${s.exam_level||""}</td>
      <td>${s.exam_center||""}</td>
      <td>${s.form_status||""}</td>
      <td>${s.payment_status||""}</td>
      <td><button class="btn-view">View</button></td>`;
    tr.querySelector("button").onclick=()=>view(s);
    tbody.appendChild(tr);
  });
  msg.textContent="Loaded successfully";
}
load();

function pub(path){
  if(!path) return "";
  return sb.storage.from("student_docs").getPublicUrl(path).data.publicUrl;
}

function view(s){
  currentId=s.id;
  details.style.display="block";
  dName.textContent=s.full_name||"";
  dFather.textContent=s.father_name||"";
  dMobile.textContent=s.mobile||"";
  dRoll.textContent=s.roll_number||"";
  dExam.textContent=s.exam_level||"";
  dStatus.textContent=s.form_status||"";
  dPhoto.href=pub(s.photo_path);
  dAF.href=pub(s.aadhar_front_path);
  dAB.href=pub(s.aadhar_back_path);
  dM.href=pub(s.marksheet_path);
}

async function setStatus(v){
  if(!currentId)return;
  await sb.from("students").update({form_status:v}).eq("id",currentId);
  load();
}
</script>

</body>
</html>
