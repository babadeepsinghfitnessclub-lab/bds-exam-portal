<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äì Gallery Upload | BDS Exam Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; }
    .container {
      max-width: 800px;
      margin: 20px auto;
      background:#fff;
      padding: 15px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    h1 { margin-top:0; color:#b20c0c; }
    label { display:block; margin-top:8px; font-size:14px; }
    input[type="text"] {
      width:100%; padding:7px; box-sizing:border-box;
      border-radius:4px; border:1px solid #ccc; margin-top:3px;
    }
    input[type="file"] { margin-top:5px; }
    button {
      margin-top:12px; padding:8px 14px;
      border:none; border-radius:4px;
      background:#1976d2; color:#fff;
      cursor:pointer; font-size:14px;
    }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .msg { margin-top:8px; font-size:13px; }
    .preview-list { margin-top:15px; display:flex; flex-wrap:wrap; gap:10px; }
    .preview-item {
      width:120px; text-align:center; font-size:12px;
    }
    .preview-item img {
      width:110px; height:110px; object-fit:cover;
      border-radius:6px; border:1px solid #ccc;
    }
    .topbar-links a { margin-right:8px; font-size:13px; text-decoration:none; color:#1976d2; }
  </style>

  <!-- Supabase JS (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
</head>
<body>

<div class="container">
  <div class="topbar-links">
    <a href="dashboard.html">‚Üê Admin Home</a>
    <span>|</span>
    <a href="../gallery.html" target="_blank">View Gallery Page</a>
  </div>

  <h1>Gallery Photo Upload</h1>
  <p style="font-size:13px;">
    Yahan se jo photo upload karoge, woh <b>gallery.html</b> page par dikhengi.<br>
    Supabase me <code>gallery_items</code> table aur <code>gallery</code> bucket use ho raha hai.
  </p>

  <label>Select Image File</label>
  <input type="file" id="photoFile" accept="image/*">

  <label>Caption (optional)</label>
  <input type="text" id="captionInput" placeholder="Jaise: Exam hall, Prize distribution...">

  <label style="margin-top:10px;">
    <input type="checkbox" id="visibleCheck" checked>
    Visible in Gallery
  </label>

  <button id="uploadBtn">Upload to Gallery</button>
  <p class="msg" id="msgBox"></p>

  <h3 style="margin-top:20px;">Latest Uploaded Photos</h3>
  <div id="previewList" class="preview-list"></div>
</div>

<script>
  // üîê Admin login check
  if (localStorage.getItem("bdsAdminLoggedIn") !== "yes") {
    window.location.href = "login.html";
  }

  // üîß Supabase config
  const SUPABASE_URL = "https://yyymjhuwjvyykukfzqow.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eW1qaHV3anZ5eWt1a2Z6cW93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzMzMjIsImV4cCI6MjA4MDI0OTMyMn0.Ja9Do4cwumTnXx2NGIRW8Ti3rKm4MBiLClQz0xjOtrQ";
  const BUCKET_NAME = "gallery";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const photoFileInput = document.getElementById("photoFile");
  const captionInput   = document.getElementById("captionInput");
  const visibleCheck   = document.getElementById("visibleCheck");
  const uploadBtn      = document.getElementById("uploadBtn");
  const msgBox         = document.getElementById("msgBox");
  const previewList    = document.getElementById("previewList");

  uploadBtn.addEventListener("click", async () => {
    const file = photoFileInput.files[0];
    const caption = captionInput.value.trim();
    const visible = visibleCheck.checked;

    if (!file) {
      msgBox.style.color = "red";
      msgBox.textContent = "Please select an image file.";
      return;
    }

    msgBox.style.color = "#000";
    msgBox.textContent = "Uploading photo, please wait...";
    uploadBtn.disabled = true;

    try {
      // 1) Storage me file upload
      const filePath = gallery/${Date.now()}_${file.name};

      const { data: uploadData, error: uploadError } =
        await supabase.storage.from(BUCKET_NAME).upload(filePath, file, {
          upsert: true
        });

      if (uploadError) {
        console.error(uploadError);
        throw new Error(uploadError.message || "Upload failed");
      }

      // 2) Public URL nikalna
      const { data: publicData } =
        supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);

      const publicUrl = publicData.publicUrl;

      // 3) gallery_items table me row insert
      const { error: insertError } = await supabase
        .from("gallery_items")
        .insert({
          caption: caption || null,
          file_path: filePath,
          public_url: publicUrl,
          visible: visible,
          created_at: new Date().toISOString()
        });

      if (insertError) {
        console.error(insertError);
        throw new Error(insertError.message || "DB insert failed");
      }

      msgBox.style.color = "green";
      msgBox.textContent = "Photo uploaded successfully. Gallery page me show ho jayegi.";

      photoFileInput.value = "";
      captionInput.value = "";
      visibleCheck.checked = true;

      loadLatestPhotos();

    } catch (err) {
      console.error(err);
      msgBox.style.color = "red";
      msgBox.textContent = "File upload error: " + err.message;
    } finally {
      uploadBtn.disabled = false;
    }
  });

  async function loadLatestPhotos() {
    previewList.innerHTML = "Loading...";

    const { data, error } = await supabase
      .from("gallery_items")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) {
      console.error(error);
      previewList.textContent = "Error loading preview: " + error.message;
      return;
    }

    if (!data || data.length === 0) {
      previewList.textContent = "No photos uploaded yet.";
      return;
    }

    previewList.innerHTML = "";
    data.forEach(row => {
      const div = document.createElement("div");
      div.className = "preview-item";
      div.innerHTML = `
        <img src="${row.public_url}" alt="img">
        <div>${row.caption || ""}</div>
        <div style="font-size:11px; color:${row.visible ? "green" : "red"};">
          ${row.visible ? "Visible" : "Hidden"}
        </div>
      `;
      previewList.appendChild(div);
    });
  }

  loadLatestPhotos();
</script>

</body>
</html>
