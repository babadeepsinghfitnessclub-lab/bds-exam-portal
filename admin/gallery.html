<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äì Gallery Upload | BDS Exam Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; }
    .container {
      max-width: 800px;
      margin: 20px auto;
      background:#fff;
      padding: 15px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    h1 { margin-top:0; color:#b20c0c; }
    label { display:block; margin-top:8px; font-size:14px; }
    input[type="text"] {
      width:100%; padding:7px; box-sizing:border-box;
      border-radius:4px; border:1px solid #ccc; margin-top:3px;
    }
    input[type="file"] { margin-top:5px; }
    button {
      margin-top:12px; padding:8px 14px;
      border:none; border-radius:4px;
      background:#1976d2; color:#fff;
      cursor:pointer; font-size:14px;
    }
    .msg { margin-top:8px; font-size:13px; }
    .preview-list { margin-top:15px; display:flex; flex-wrap:wrap; gap:10px; }
    .preview-item {
      width:120px; text-align:center; font-size:12px;
    }
    .preview-item img {
      width:110px; height:110px; object-fit:cover;
      border-radius:6px; border:1px solid #ccc;
    }
    .topbar-links a { margin-right:8px; font-size:13px; }
  </style>

  <!-- Firebase v8 (app + firestore + storage) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>

<div class="container">
  <div class="topbar-links">
    <a href="dashboard.html">‚Üê Admin Home</a>
    <span>|</span>
    <a href="../gallery.html" target="_blank">View Gallery Page</a>
  </div>

  <h1>Gallery Photo Upload</h1>
  <p style="font-size:13px;">
    Yahan se jo photo upload karoge, woh <b>gallery.html</b> page par dikhengi.
    Firestore me <code>gallery</code> collection use ho raha hai.
  </p>

  <label>Select Image File</label>
  <input type="file" id="photoFile" accept="image/*">

  <label>Caption (optional)</label>
  <input type="text" id="captionInput" placeholder="Jaise: Exam hall, Prize distribution...">

  <label style="margin-top:10px;">
    <input type="checkbox" id="visibleCheck" checked>
    Visible in Gallery
  </label>

  <button id="uploadBtn">Upload to Gallery</button>
  <p class="msg" id="msgBox"></p>

  <h3 style="margin-top:20px;">Latest Uploaded Photos</h3>
  <div id="previewList" class="preview-list"></div>
</div>

<script>
  // üîê Admin login check
  if (localStorage.getItem("bdsAdminLoggedIn") !== "yes") {
    window.location.href = "login.html";
  }

  // Same Firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyC87KEyqV3BMDeIexM_kom2rR7AMQ67eQ8",
    authDomain: "bds-exam-portal.firebaseapp.com",
    projectId: "bds-exam-portal",
    storageBucket: "bds-exam-portal.appspot.com",
    messagingSenderId: "376704151840",
    appId: "1:376704151840:web:1f530924b850e008434883"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  var db = firebase.firestore();
  var storage = firebase.storage();

  var photoFileInput = document.getElementById("photoFile");
  var captionInput   = document.getElementById("captionInput");
  var visibleCheck   = document.getElementById("visibleCheck");
  var uploadBtn      = document.getElementById("uploadBtn");
  var msgBox         = document.getElementById("msgBox");
  var previewList    = document.getElementById("previewList");

  uploadBtn.addEventListener("click", function(){
    var file = photoFileInput.files[0];
    var caption = captionInput.value.trim();
    var visible = visibleCheck.checked;

    if (!file) {
      msgBox.style.color = "red";
      msgBox.textContent = "Please select an image file.";
      return;
    }

    msgBox.style.color = "#000";
    msgBox.textContent = "Uploading photo, please wait...";
    uploadBtn.disabled = true;

    var path = "gallery/" + Date.now() + "_" + file.name;

    storage.ref().child(path).put(file)
      .then(function(snap){
        return snap.ref.getDownloadURL();
      })
      .then(function(url){
        return db.collection("gallery").add({
          url: url,
          caption: caption,
          visible: visible,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      })
      .then(function(){
        msgBox.style.color = "green";
        msgBox.textContent = "Photo uploaded successfully. Gallery page me show ho jayegi.";
        photoFileInput.value = "";
        captionInput.value = "";
        visibleCheck.checked = true;
        loadLatestPhotos();
      })
      .catch(function(err){
        console.error(err);
        msgBox.style.color = "red";
        msgBox.textContent = "Error uploading photo: " + err;
      })
      .finally(function(){
        uploadBtn.disabled = false;
      });
  });

  // Latest photos preview for admin
  function loadLatestPhotos(){
    previewList.innerHTML = "Loading...";
    db.collection("gallery")
      .orderBy("createdAt", "desc")
      .limit(12)
      .get()
      .then(function(snapshot){
        previewList.innerHTML = "";
        snapshot.forEach(function(doc){
          var d = doc.data();
          var div = document.createElement("div");
          div.className = "preview-item";
          div.innerHTML = `
            <img src="${d.url}" alt="img">
            <div>${d.caption || ""}</div>
            <div style="font-size:11px; color:${d.visible ? 'green':'red'};">
              ${d.visible ? 'Visible' : 'Hidden'}
            </div>
          `;
          previewList.appendChild(div);
        });
      })
      .catch(function(err){
        console.error(err);
        previewList.innerHTML = "Error loading preview: " + err;
      });
  }

  loadLatestPhotos();
</script>

</body>
</html>
